<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
    <meta charset="utf-8"/>
    <title>(fn[] &quot;less is more&quot;)</title>
    <link rel="canonical" href="http://clonekim.github.io/">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href='http://fonts.googleapis.com/css?family=Alegreya:400italic,700italic,400,700' rel='stylesheet'
          type='text/css'>
    <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.0/css/bootstrap.min.css">
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet">
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.7.0/styles/default.min.css">
    <link href="/css/screen.css" rel="stylesheet" type="text/css" />
</head>
<body>


<nav class="navbar navbar-default">
    <div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">(fn[] &quot;less is more&quot;)</a>
        </div>
        <div id="navbar" class="navbar-collapse collapse">
            <ul class="nav navbar-nav navbar-right">
                <li  class="active" ><a href="/">Home</a></li>
                <li
                ><a href="/archives/">Archives</a></li>
                
                <li
                >
                <a href="/pages/about/">About</a>
                </li>
                
                <li><a href="/feed.xml">RSS</a></li>
            </ul>
        </div><!--/.nav-collapse -->
    </div><!--/.container-fluid -->
</nav>


<div class="container">


    <div class="row">
        <div class="col-lg-9">
            <div id="content">
                
<div id="post">
    <div class="post-header">
    <div id="post-meta" class="row">
        <div class="col-lg-6">2018년 12월 24일 (월)</div>
        
    </div>
    <h2>Spark</h2>
</div>
<div>
    <ol class="content"><li><a href="#파일_처리">파일 처리</a></li><li><a href="#jdbc를_통해_소스_읽어오기">JDBC를 통해 소스 읽어오기</a></li><li><a href="#jdbc로_통해_write_처리">JDBC로 통해 Write 처리</a></li><li><a href="#flatmap_사용해봄">flatMap 사용해봄</a></li></ol>
    <p>현재 특정 테이블의 태그정보와 아래와 같다</p><p>특정컬럼에 태그 값이 컴마 구분으로 들어있음</p><table><thead><tr><th>tags</th></tr></thead></table>| 태그, 태그, 태그|<h2 id="파일&#95;처리">파일 처리</h2><p>해당 컬럼만 csv로 만들어본것</p><pre><code class="python"># -&#42;- coding: utf-8 -&#42;-

from pyspark import SparkConf
from pyspark import SparkContext
from pyspark.sql import SparkSession
from pyspark.sql.types import &#42;


lines = sc.textFile&#40;'&#91;csv파일&#93;', use&#95;unicode=True&#41;
counts = lines.flatMap&#40;lambda line: line.split&#40;','&#41;&#41;.map&#40;lambda word: &#40;word,1&#41;&#41;.reduceByKey&#40;lambda a,b : a + b&#41;


schema = StructType&#40;&#91;
  StructField&#40;'tag', StringType&#40;&#41;, False&#41;,
  StructField&#40;'count', IntegerType&#40;&#41;, False&#41;,
&#93;&#41;

df = spark.createDataFrame&#40;counts, schema&#41;

df.show&#40;&#41;
</code></pre><p><img src="/img/spark/show-df.png" alt="show-df.png" /></p><h2 id="jdbc를&#95;통해&#95;소스&#95;읽어오기">JDBC를 통해 소스 읽어오기</h2><p>그냥 jdbc를 통해서 바로 데이터프레임으로 만들어 본것</p><pre><code class="python">dbDataFrame = spark.read.format&#40;'jdbc'&#41; \
                             .option&#40;'url', url&#41; \
                             .option&#40;'dbtable', 'popular&#95;product&#95;ranks'&#41; \
                             .option&#40;'driver',  driver&#41; \
                             .option&#40;'user', user&#41;
                             .option&#40;'password', password&#41;.load&#40;&#41;

</code></pre><h2 id="jdbc로&#95;통해&#95;write&#95;처리">JDBC로 통해 Write 처리</h2><p>처리결과를 바로 대쉬보드 역을 하는 테이블에 다시 쓰기</p><pre><code class="python">from pyspark import SparkConf
from pyspark import SparkContext
from pyspark.sql import SparkSession
from pyspark.sql.types import &#42;

def main&#40;&#41;:
conf = SparkConf&#40;&#41;
conf.setAppName&#40;'save&#95;tags&#95;jdbc'&#41;
sc = SparkContext&#40;conf=conf&#41;
spark = SparkSession&#40;sc&#41;

schema = StructType&#40;&#91;
StructField&#40;'tag', StringType&#40;&#41;, False&#41;,
StructField&#40;'count', IntegerType&#40;&#41;, False&#41;,
&#93;&#41;

lines = sc.textFile&#40;'/home/bonjour/spark-master/data/tags.txt', use&#95;unicode=True&#41;
counts = lines.flatMap&#40;lambda line: line.split&#40;','&#41;&#41;.map&#40;lambda word: &#40;word,1&#41;&#41;.reduceByKey&#40;lambda a,b : a + b&#41;

df = spark.createDataFrame&#40;counts, schema&#41;
df.write.format&#40;'jdbc'&#41;.options&#40;
url='&#91;jdbc url&#93;',
        user='&#91;user&#93;',
        password='&#91;password&#93;',
        driver='org.mariadb.jdbc.Driver',
        dbtable='top&#95;tags'&#41;.mode&#40;'overwrite'&#41;.save&#40;&#41;
</code></pre><h2 id="flatmap&#95;사용해봄">flatMap 사용해봄</h2><p><i>테이블 A</i></p><p>|product_no|  |&ndash; |</p><table><thead><tr></tr></thead><tbody><tr></tr></tbody></table><p><i>테이블 B</i></p><p>|product_no | tags |</p><table><thead><tr></tr></thead></table>| 1 | 예쁜, 20대여성...|| 2 | 20대여성, 스타일이 좋은, 핏이 좋은...|<p>이럴 경우 flatMap을 이용해 아래와 같이 만든다</p><p>|product_no| tag|</p><table><thead><tr></tr></thead></table>| 1 | 예쁜|| 1 | 20대여성|| 2 | 20대여성|| 2 | 스타일이 좋은|<pre><code class="python">df = spark.read.format&#40;'jdbc'&#41;\
            .option&#40;'url', url&#41; \
            .option&#40;'dbtable', table&#41; \
            .option&#40;'driver',  driver&#41; \
            .option&#40;'user', user&#41; \
            .option&#40;'password', password&#41;.load&#40;&#41;

df.filter&#40;df&#91;'tags'&#93; != ''&#41;\
  .select&#40;df&#91;'product&#95;no'&#93;, df&#91;'tags'&#93;&#41;\
  .rdd \
  .flatMap&#40;lambda row: &#40;&#40;int&#40;row&#91;0&#93;&#41;, v&#41; for v in row&#91;1&#93;.split&#40;','&#41;&#41;&#41;
</code></pre>
</div>

<div id="post-tags">
    <b>Tags: </b>
    
    <a href="/tags/spark/">spark</a>
    
    <a href="/tags/태그집계/">태그집계</a>
    
</div>


    
    <div id="comments">
        <a href="/posts/2018-12-24-aggregation-tags-with-spark/#disqus_thread">View Comments</a>
    </div>
    

    <div id="prev-next">
        
        
        <a class="right" href="/posts/2018-12-24-how-spark/">Spark &raquo;</a>
        
    </div>
</div>

            </div>
        </div>

        <div class="col-md-3">
            <div id="sidebar">
                <h3>Links</h3>
                <ul id="links">
                    <li><a href="http://cryogenweb.org/docs/home.html">Cryogen Docs</a></li>
                    <li><a href="http://carmenla.me/blog/archives">Carmen's Blog</a></li>
                    
                    <li><a href="/pages/guick-guide/">Quick Start Guide</a></li>
                    
                </ul>
                
                <div id="recent">
                    <h3>Recent Posts</h3>
                    <ul>
                        
                        <li><a href="/posts/2018-12-24-aggregation-tags-with-spark/">Spark</a></li>
                        
                        <li><a href="/posts/2018-12-24-how-spark/">Spark</a></li>
                        
                        <li><a href="/posts/2018-07-05-ERAlchemy/">ERAlchemy 를 이용한 ERD작성</a></li>
                        
                        <li><a href="/posts/2017-11-02-go-repl/">Go Repl</a></li>
                        
                        <li><a href="/posts/2017-11-02-emacs-golang/">Emacs에서 Golang 를 위한 에디팅</a></li>
                        
                    </ul>
                </div>
                
                
                <div id="tags">
                    <h3>Tags</h3>
                    <ul>
                        
                        <li><a href="/tags/svn/">svn</a></li>
                        
                        <li><a href="/tags/cryogen/">cryogen</a></li>
                        
                        <li><a href="/tags/imagemagick/">imagemagick</a></li>
                        
                        <li><a href="/tags/gnome/">gnome</a></li>
                        
                        <li><a href="/tags/github/">github</a></li>
                        
                        <li><a href="/tags/clojure/">clojure</a></li>
                        
                        <li><a href="/tags/redmine/">redmine</a></li>
                        
                        <li><a href="/tags/raspberry/">raspberry</a></li>
                        
                        <li><a href="/tags/aws/">aws</a></li>
                        
                        <li><a href="/tags/oracle/">oracle</a></li>
                        
                        <li><a href="/tags/spark/">spark</a></li>
                        
                        <li><a href="/tags/web programming/">web programming</a></li>
                        
                        <li><a href="/tags/vi/">vi</a></li>
                        
                        <li><a href="/tags/gulp/">gulp</a></li>
                        
                        <li><a href="/tags/linux/">linux</a></li>
                        
                        <li><a href="/tags/captcha/">captcha</a></li>
                        
                        <li><a href="/tags/java/">java</a></li>
                        
                        <li><a href="/tags/wiki/">wiki</a></li>
                        
                        <li><a href="/tags/io/">io</a></li>
                        
                        <li><a href="/tags/pi/">pi</a></li>
                        
                        <li><a href="/tags/php/">php</a></li>
                        
                        <li><a href="/tags/go/">go</a></li>
                        
                        <li><a href="/tags/mariadb/">mariadb</a></li>
                        
                        <li><a href="/tags/emacs/">emacs</a></li>
                        
                        <li><a href="/tags/freemarker/">freemarker</a></li>
                        
                        <li><a href="/tags/OGNL/">OGNL</a></li>
                        
                        <li><a href="/tags/nginx/">nginx</a></li>
                        
                        <li><a href="/tags/windows/">windows</a></li>
                        
                        <li><a href="/tags/ruby/">ruby</a></li>
                        
                        <li><a href="/tags/jdbc/">jdbc</a></li>
                        
                        <li><a href="/tags/docker/">docker</a></li>
                        
                        <li><a href="/tags/angular/">angular</a></li>
                        
                        <li><a href="/tags/template/">template</a></li>
                        
                        <li><a href="/tags/jruby/">jruby</a></li>
                        
                        <li><a href="/tags/concurrent/">concurrent</a></li>
                        
                        <li><a href="/tags/angularjs/">angularjs</a></li>
                        
                        <li><a href="/tags/javascript/">javascript</a></li>
                        
                        <li><a href="/tags/python/">python</a></li>
                        
                        <li><a href="/tags/microframework/">microframework</a></li>
                        
                        <li><a href="/tags/proxy/">proxy</a></li>
                        
                        <li><a href="/tags/game/">game</a></li>
                        
                        <li><a href="/tags/node.js/">node.js</a></li>
                        
                        <li><a href="/tags/태그집계/">태그집계</a></li>
                        
                        <li><a href="/tags/react/">react</a></li>
                        
                        <li><a href="/tags/taglib/">taglib</a></li>
                        
                        <li><a href="/tags/clojurescript/">clojurescript</a></li>
                        
                        <li><a href="/tags/jsp/">jsp</a></li>
                        
                    </ul>
                </div>
                
            </div>
        </div>
    </div>
    <footer>Copyright &copy; 2018 DAEHEE KIM
        <p style="text-align: center;">Powered by <a href="http://cryogenweb.org">Cryogen</a></p></footer>
</div>
<script src="//code.jquery.com/jquery-1.11.0.min.js"></script>
<script src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.0/js/bootstrap.min.js"></script>
<script src="/js/highlight.pack.js" type="text/javascript"></script>
<script>hljs.initHighlightingOnLoad();</script>


</body>
</html>
